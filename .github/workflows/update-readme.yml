name: Auto-update README
on:
  schedule:
    - cron: "*/30 * * * *"  # every 30 min
  workflow_dispatch:
  repository_dispatch:
    types: [update-profile]

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cli/gh-action@v2

      - name: Generate dynamic sections
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_USER: jonnyterrero
        run: |
          set -euo pipefail
          gh api "/users/$GH_USER/repos?sort=pushed&per_page=7" > repos.json

          echo "ðŸ§­ Auto-updated from your latest activity." > recent.md
          jq -r '.[] |
            "- **\(.name)** â€” updated \(.pushed_at | sub("T";" ") | sub("Z";" UTC"))  \n  [repo](\(.html_url)) â€¢ â˜…\(.stargazers_count) â€¢ forks:\(.forks_count)"' repos.json >> recent.md

          : > commits.md
          for r in $(jq -r '.[].name' repos.json | head -n 4); do
            gh api "/repos/$GH_USER/$r/commits?per_page=1" | jq -r --arg r "$r" '
              if (type=="array" and length>0) then
                .[0] |
                "- **" + $r + "**: \(.commit.message)  \n  [\(.sha[0:7])](\(.html_url)) â€¢ \(.commit.author.date | sub("T";" ") | sub("Z";" UTC"))"
              else empty end
            ' >> commits.md || true
          done

          awk '
            BEGIN{inblock=0}
            /<!--RECENT_START-->/ {print; system("cat recent.md"); inblock=1; next}
            /<!--RECENT_END-->/ {inblock=0}
            /<!--COMMITS_START-->/ {print; system("cat commits.md"); inblock=2; next}
            /<!--COMMITS_END-->/ {inblock=0}
            !inblock {print}
          ' README.md > README.new

          mv README.new README.md

      - name: Commit changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "chore: auto-update README [skip ci]"
            git push
          else
            echo "No changes."
          fi
