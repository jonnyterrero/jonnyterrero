name: Auto-update README
on:
  schedule:
    - cron: "*/30 * * * *"  # every 30 min
  workflow_dispatch:
  repository_dispatch:
    types: [update-profile]

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup GitHub CLI
        uses: cli/gh-action@v2
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate dynamic sections
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_USER: jonnyterrero
        run: |
          set -e
          
          echo "Fetching repositories..."
          if ! gh api "/users/$GH_USER/repos?sort=pushed&per_page=7" > repos.json; then
            echo "Error: Failed to fetch repositories"
            exit 1
          fi
          
          if [ ! -s repos.json ]; then
            echo "Error: repos.json is empty"
            exit 1
          fi

          echo "ðŸ§­ Auto-updated from your latest activity." > recent.md
          if ! jq -r '.[] |
            "- **\(.name)** â€” updated \(.pushed_at | sub("T";" ") | sub("Z";" UTC"))  \n  [repo](\(.html_url)) â€¢ â˜…\(.stargazers_count) â€¢ forks:\(.forks_count)"' repos.json >> recent.md; then
            echo "Warning: Failed to process repositories with jq"
          fi

          : > commits.md
          for r in $(jq -r '.[].name' repos.json 2>/dev/null | head -n 4); do
            if [ -n "$r" ]; then
              gh api "/repos/$GH_USER/$r/commits?per_page=1" 2>/dev/null | jq -r --arg r "$r" '
                if (type=="array" and length>0) then
                  .[0] |
                  "- **" + $r + "**: \(.commit.message)  \n  [\(.sha[0:7])](\(.html_url)) â€¢ \(.commit.author.date | sub("T";" ") | sub("Z";" UTC"))"
                else empty end
              ' >> commits.md 2>/dev/null || true
            fi
          done

          if [ ! -f README.md ]; then
            echo "Error: README.md not found"
            exit 1
          fi

          if ! grep -q "<!--RECENT_START-->" README.md || ! grep -q "<!--RECENT_END-->" README.md; then
            echo "Warning: RECENT markers not found in README.md, skipping update"
            exit 0
          fi

          awk '
            BEGIN{inblock=0}
            /<!--RECENT_START-->/ {print; system("cat recent.md"); inblock=1; next}
            /<!--RECENT_END-->/ {inblock=0}
            /<!--COMMITS_START-->/ {print; system("cat commits.md"); inblock=2; next}
            /<!--COMMITS_END-->/ {inblock=0}
            !inblock {print}
          ' README.md > README.new

          if [ -f README.new ]; then
            mv README.new README.md
          else
            echo "Error: Failed to generate README.new"
            exit 1
          fi

      - name: Commit changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "chore: auto-update README [skip ci]"
            git push
          else
            echo "No changes."
          fi
